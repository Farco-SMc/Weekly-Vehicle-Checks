<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vehicle Checks and Maintenance</title>
  <style>
    /* Header styling with logo */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .logo {
      max-height: 35px;
      width: auto;
      margin-left: 20px;
    }
    /* Base styling */
    body {
      font-family: "Gill Sans", "Segoe UI", sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
      color: #34434c;
    }
    .container {
      max-width: 600px;
      background-color: #ffffff;
      margin: auto;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h2 {
      font-family: "Begum Semi Bold", "Gill Sans", sans-serif;
      font-size: 28px;
      margin-bottom: 10px;
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #a1afae;
      border-radius: 4px;
      box-sizing: border-box;
    }
    input[type="checkbox"],
    input[type="radio"] {
      margin-right: 8px;
    }
    button {
      background-color: #f7941d; /* FARCO Orange */
      color: #ffffff;
      padding: 12px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #d77c15;
    }
    .hidden {
      display: none;
    }
    /* Step wizard styles */
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    #progressIndicator {
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
    }
    /* Navigation buttons: Back always on left (using visibility so space remains) and Next always on right */
    #navigationButtons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    #backBtn {
      visibility: hidden; /* Reserve space even when hidden */
    }
    /* Preview container and delete button */
    .previewContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .previewItem {
      position: relative;
      display: inline-block;
    }
    .previewItem img {
      max-width: 100px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .deleteBtn {
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 12px;
      line-height: 18px;
      padding: 0;
    }
    /* Image options buttons */
    #imageOptions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    #imageOptions button {
      flex: 1;
    }
    /* Modal for camera interface */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.hidden {
      display: none !important;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      position: relative;
      text-align: left;
      max-width: 90%;
      width: 400px;

      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content video {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .modal-content .close {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 36px;
      cursor: pointer;
      color: #aaa;
      padding: 10px;
      line-height: 1;
      z-index: 10; /* ensures click */
    }
    #captureStatus {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 16px;
      z-index: 1100;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #f7941d;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #faqButtonContainer {
      text-align: center;
      margin-top: 20px;
    }
    .fluid-grid-row {
      display: grid;
      grid-template-columns: 120px repeat(3, 1fr);
      align-items: center;
      gap: 6px;
      padding: 2px 0;
      margin-bottom: 12px;
      font-weight: normal;
      font-size: 0.95em;
    }
    .fluid-label {
      width: 100px;
      font-weight: bold;
      font-size: 0.95em;
      color: #444;
    }
    .fluid-grid-row label {
      margin-right: 15px;
      font-weight: normal;
      font-size: 0.95em;
    }
    textarea#dailyNotes,
    textarea#weeklyNotes {
      font-family: "Gill Sans", sans-serif;
    }
    /* ────────────────────────────────────────────── */
      /* Breakdowns: toggle buttons (active vs. normal) */
      /* ────────────────────────────────────────────── */
      #btnReportBreakdown,
      #btnUpdateBreakdown {
        background-color: #f0f0f0;
        color: #34434c;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        margin-right: 8px;
      }
      #btnReportBreakdown.active,
      #btnUpdateBreakdown.active {
        background-color: #f7941d;
        color: #fff;
        border-color: #d77c15;
      }

      /* ────────────────────────────────────────────── */
      /* Breakdowns: date + time side‐by‐side inputs   */
      /* ────────────────────────────────────────────── */
      .date-time-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .date-time-group input {
        flex: 1;
      }

      /* ────────────────────────────────────────────── */
      /* Breakdowns: “not safe” warning text           */
      /* ────────────────────────────────────────────── */
      #safePlaceWarning {
        margin-top: 10px;
        padding: 10px;
        background-color: #ffe5e5;
        border: 1px solid #ffcccc;
        border-radius: 4px;
        font-size: 0.9em;
        color: #a94442;
      }
  </style>
</head>
<body>
  <!-- ======================= -->
  <!-- LANDING PAGE SECTION   -->
  <!-- ======================= -->
  <div id="landingPage" class="container">
     <div class="header" style="justify-content: center; margin-bottom: 20px;">
    <img src="logo.png" alt="Logo" class="logo" style="max-height: 50px;">
  </div>
  <h2 style="text-align: center;" >Please Select an Option</h2>
    <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 20px;">
      <button id="btnVehicleChecks" style="width: 200px; text-align: center;">
        Vehicle Checks
      </button>
      <button id="btnBreakdowns" style="width: 200px; text-align: center;">
        Breakdowns
      </button>
    </div>
  </div>

  <!-- ============================ -->
  <!-- VEHICLE CHECKS SECTION       -->
  <!-- ============================ -->
  <div id="vehicleChecksSection" class="container hidden">
    <!-- Back to Home Button -->
    <div style="margin-bottom: 20px;">
      <button id="btnBackToHomeFromVehicle" style="background:none; border:none; color:#f7941d; font-size:16px; cursor:pointer;">
        &larr; Back to Home
      </button>
    </div>

    <div class="header">
      <h2>Vehicle Checks and Maintenance</h2>
      <img src="logo.png" alt="Logo" class="logo">
    </div>
    <div id="progressIndicator">Step 1</div>
    <form id="vehicleForm" method="POST" enctype="multipart/form-data">
      <!-- Hidden fields -->
      <input type="hidden" id="checkType" name="checkType" />
      <input type="hidden" id="imagesUploaded" name="imagesUploaded" value="No">
      
      <!-- Step 1: Common Details -->
      <div class="step" id="commonDetails">
        <div class="form-group">
          <label>Is this your first vehicle check for this vehicle as part of this route?</label>
          <input type="radio" name="firstCheck" value="Yes" required onclick="setCheckType('Weekly')"> Yes
          <input type="radio" name="firstCheck" value="No" onclick="setCheckType('Daily')"> No
        </div>
        <div class="form-group">
          <label for="driverName">Driver Name:</label>
          <select id="driverName" name="driverName" required onchange="toggleDriverOther()">
            <option value="">Select Driver Name</option>
            <option value="Mat Roberts">Mat Roberts</option>
            <option value="Leo Baptiste">Leo Baptiste</option>
            <option value="Ed Sykes">Ed Sykes</option>
            <option value="Stewart Kenny">Stewart Kenny</option>
            <option value="Frank Libal">Frank Libal</option>
            <option value="Chris Bull">Chris Bull</option>
            <option value="Julia Stockdale">Julia Stockdale</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group hidden" id="otherDriverNameContainer">
          <label for="otherDriverName">Please enter driver name:</label>
          <input type="text" id="otherDriverName" name="otherDriverName" disabled>
        </div>
        <div class="form-group">
          <label for="vehicleReg">Vehicle Registration:</label>
          <select id="vehicleReg" name="vehicleReg" required onchange="toggleVanOther(); updateTyrePressureNote();">
            <option value="">Select Registration</option>
            <option value="BV72 JVN">BV72 JVN - Black Renault Master</option>
            <option value="LB25 UKY">LB25 UKY - White Fiat Luton</option>
            <option value="PY25 CKL">PY25 CKL - White Maxus (new)</option>
            <option value="LO19 CGE">LO19 CGE - Black Citroen Relay</option>
            <option value="PY24 LZE">PY24 LZE - White Maxus</option>
            <option value="Rental Van">Rental Van</option>
          </select>
        </div>
        <div class="form-group hidden" id="rentalVanContainer">
          <label for="rentalVanName">Please enter rental van registration, make and model:</label>
          <input type="text" id="rentalVanName" name="rentalVanName" disabled>
        </div>
        <div class="form-group hidden" id="currentMileageGroup">
          <label for="currentMileage">Current Mileage:</label>
          <input type="text" id="currentMileage" name="currentMileage" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
        </div>
      </div>
      
      <!-- Step 2a: Daily Check Fields (for Daily branch) -->
      <div class="step hidden" id="dailyStep">
        <div class="form-group">
          <label><input type="checkbox" name="vehicleWalkAround" value="complete"> Vehicle Walk Around Completed</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
            Visually inspect the exterior, checking for any obvious damage, loose parts, or debris.
          </span>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="checkLights" value="checked"> Lights Checked</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
            Confirm that all exterior lights (headlights, tail lights, indicators) are functioning correctly.
          </span>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="dashLightsWorkingDaily" value="checked"> Dash Lights Checked</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
            Ensure the instrument panel lights are working and clearly visible.
          </span>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="checkFluidLevels" value="checked"> Fluid Levels Checked</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
            Check engine oil, coolant, and other fluids for proper levels.
          </span>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="checkTyres" value="checked"> Tyres Checked</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
            Inspect tyres for tread depth, damage to side walls, proper inflation and check that wheel nuts are secure.
          </span>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="checkBrakes" value="checked"> Brakes Checked</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
            Test that the brakes are functioning before setting off.
          </span>
        </div>
        <div class="form-group">
          <label>Fault or Damage?</label>
          <input type="radio" name="dailyFaultOption" value="Yes" id="dailyFaultYes"> Yes
          <input type="radio" name="dailyFaultOption" value="No" id="dailyFaultNo" checked> No
        </div>
        <div class="form-group hidden" id="dailyFaultDescriptionContainer">
          <label for="dailyFaultDescription">Please describe the fault/damage:</label>
          <input type="text" id="dailyFaultDescription" name="dailyFaultDescription" disabled>
        </div>
        <div class="form-group">
          <label for="dailyNotes">Other Notes and Comments:</label>
          <textarea id="dailyNotes" name="dailyNotes" rows="3" placeholder="Optional notes about the vehicle or check..."></textarea>
        </div>
      </div>
      
      <!-- Step 2b: Weekly Check Fields (for Weekly branch) -->
      <div class="step hidden" id="weeklyStep">
        <div class="form-group">
          <label>Tyre Pressure (psi):</label>
          <p style="font-size: 0.9em; color: #555; margin: -2px 0 10px;">Orientation is from the perspective of driving the vehicle.</p>
          <p id="tyrePressureNote" style="font-size: 0.9em; color: #333; font-weight: bold;"></p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label for="tyrePressureFrontLeft">Front Left:</label>
              <input type="text" id="tyrePressureFrontLeft" name="tyrePressureFrontLeft" inputmode="decimal"
                pattern="[0-9]+(\.[0-9]{1,2})?" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required>
            </div>
            <div>
              <label for="tyrePressureFrontRight">Front Right:</label>
              <input type="text" id="tyrePressureFrontRight" name="tyrePressureFrontRight" inputmode="decimal"
                pattern="[0-9]+(\.[0-9]{1,2})?" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required>
            </div>
            <div>
              <label for="tyrePressureBackLeft">Back Left:</label>
              <input type="text" id="tyrePressureBackLeft" name="tyrePressureBackLeft" inputmode="decimal"
                pattern="[0-9]+(\.[0-9]{1,2})?" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required>
            </div>
            <div>
              <label for="tyrePressureBackRight">Back Right:</label>
              <input type="text" id="tyrePressureBackRight" name="tyrePressureBackRight" inputmode="decimal"
                pattern="[0-9]+(\.[0-9]{1,2})?" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="tyreConditionVisual">
            Tyre Condition – Visual Check:
            <span style="display:block; font-weight: normal; font-size: 0.9em; color: #555; margin: 1px 0 10px;">Check for damage, wear, or balding.</span>
          </label>
          <select id="tyreConditionVisual" name="tyreConditionVisual" required onchange="toggleTyreConditionOther()">
            <option value="">Select Condition</option>
            <option value="Good">No visible issues</option>
            <option value="Okay">Minor wear or surface damage</option>
            <option value="Poor">Visible damage or unsafe</option>
          </select>
          <div class="form-group hidden" id="tyreConditionOtherContainer">
            <label for="tyreConditionOtherDetails">Please describe the damage:</label>
            <input type="text" id="tyreConditionOtherDetails" name="tyreConditionOtherDetails" disabled>
          </div>
        </div>
        <div class="form-group">
          <label style="font-weight: bold;">
            Are all of the tyre treads safe and in line with legal limits?
            <span style="display:block; font-weight: normal; font-size: 0.9em; color: #555; margin: 1px 0 10px;">
              Note: Legal minimum tread depth is 1.6mm across the central three-quarters.
            </span>
          </label>
          <div style="display: flex; gap: 20px;">
            <label style="font-weight: normal;">
              <input type="radio" name="tyreTreadSafety" value="Yes" required> Yes
            </label>
            <label style="font-weight: normal;">
              <input type="radio" name="tyreTreadSafety" value="No"> No
            </label>
          </div>
        </div>
        <div class="form-group">
          <label for="bodyworkGlassAndMirrors">Bodywork, Glass and Mirrors:</label>
          <p style="font-size: 0.9em; color: #555; margin: 1px 0 10px;">Includes windscreen, mirrors, lights, and doors.</p>
          <select id="bodyworkGlassAndMirrors" name="bodyworkGlassAndMirrors" required onchange="toggleBodyworkOther()">
            <option value="">Select Condition</option>
            <option value="Good">No visible damage</option>
            <option value="Okay">Minor scratches/chips</option>
            <option value="Poor">Cracks, missing parts or unsafe damage</option>
          </select>
          <div class="form-group hidden" id="bodyworkOtherContainer">
            <label for="bodyworkOtherDetails">Please describe the damage:</label>
            <input type="text" id="bodyworkOtherDetails" name="bodyworkOtherDetails" disabled>
          </div>
        </div>
        <div class="form-group">
          <label>Brakes working? (incl lights):</label>
          <input type="radio" name="brakes" value="Yes" required> Yes
          <input type="radio" name="brakes" value="No"> No
        </div>
        <div class="form-group">
          <label>Steering and suspension working?</label>
          <input type="radio" name="steeringSuspension" value="Yes" required> Yes
          <input type="radio" name="steeringSuspension" value="No"> No
        </div>
        <div class="form-group">
          <label>Lights and reflectors working?</label>
          <input type="radio" name="lightsReflectors" value="Yes" required> Yes
          <input type="radio" name="lightsReflectors" value="No"> No
        </div>
        <div class="form-group">
          <label>Dash Lights working?</label>
          <input type="radio" name="dashLightsWorkingWeekly" value="Yes" required> Yes
          <input type="radio" name="dashLightsWorkingWeekly" value="No"> No
        </div>
        <div class="form-group">
          <label>Horn working?</label>
          <input type="radio" name="horn" value="Yes" required> Yes
          <input type="radio" name="horn" value="No"> No
        </div>
        <div class="form-group">
          <label>Fluid Levels:</label>
          <div class="fluid-grid-row">
            <div class="fluid-label">Oil:</div>
            <label><input type="radio" name="oilLevel" value="Good" required> Good</label>
            <label><input type="radio" name="oilLevel" value="Needs refilling"> Needs refilling</label>
          </div>
          <div class="fluid-grid-row">
            <div class="fluid-label">Coolant:</div>
            <label><input type="radio" name="coolantLevel" value="Good" required> Good</label>
            <label><input type="radio" name="coolantLevel" value="Needs refilling"> Needs refilling</label>
          </div>
          <div class="fluid-grid-row">
            <div class="fluid-label">AdBlue:</div>
            <label><input type="radio" name="adblueLevel" value="Good" required> Good</label>
            <label><input type="radio" name="adblueLevel" value="Needs refilling"> Needs refilling</label>
            <label><input type="radio" name="adblueLevel" value="N/a"> N/a</label>
          </div>
          <div class="fluid-grid-row">
            <div class="fluid-label">Screenwash:</div>
            <label><input type="radio" name="screenwashLevel" value="Good" required> Good</label>
            <label><input type="radio" name="screenwashLevel" value="Needs refilling">Needs refilling</label>
          </div>
        </div>
        <div class="form-group">
          <label>Driver Van Kit and First Aid Kit Present?</label>
          <input type="radio" name="driverVanKitFirstAid" value="Yes" required> Yes
          <input type="radio" name="driverVanKitFirstAid" value="No"> No
        </div>
        <div class="form-group">
          <label>Fault or Damage?</label>
          <input type="radio" name="weeklyFaultOption" value="Yes"> Yes
          <input type="radio" name="weeklyFaultOption" value="No" checked> No
        </div>
        <div class="form-group hidden" id="weeklyFaultDescriptionContainer">
          <label for="weeklyFaultDescription">Please describe the fault/damage:</label>
          <input type="text" id="weeklyFaultDescription" name="weeklyFaultDescription" disabled>
        </div>
        <div class="form-group">
          <label for="weeklyNotes">Other Notes and Comments:</label>
          <textarea id="weeklyNotes" name="weeklyNotes" rows="3" placeholder="Optional notes about the vehicle or check..."></textarea>
        </div>
      </div>
      
      <!-- Step 3: Image Upload -->
      <div class="step" id="imageUploadStep">
        <div class="form-group">
          <label>Add Image(s):</label>
          <div id="imageOptions">
            <button type="button" id="uploadDeviceBtn">Upload from Device</button>
            <button type="button" id="openCameraBtn">Take Photo</button>
          </div>
          <p style="font-size: 0.9em; color: #666;">Select images from your device or capture new ones.</p>
        </div>
        <input type="file" id="galleryUpload" accept="image/*" multiple style="display:none;">
        <div id="galleryPreview" class="previewContainer"></div>
        <div id="capturedPhotos" class="previewContainer"></div>
      </div>
      
      <!-- Step 4: Review -->
      <div class="step" id="reviewStep">
        <h3 style="text-align:center;">Review Your Images</h3>
        <p style="font-size: 0.9em; color: #666; text-align:center;">Click the red delete icon to remove an image.</p>
        <div id="reviewGallery" class="previewContainer"></div>
        <div id="reviewCaptured" class="previewContainer"></div>
      </div>
      
      <!-- Step 5: Declaration -->
      <div class="step" id="declarationStep">
        <h3 style="text-align:center;">Declaration</h3>
        <p>I confirm that the above checks have been carried out and I consider the vehicle fit for use.</p>
        <p>I hereby confirm that I am fit to drive/use this vehicle, that I am aware of the company policies and the law on alcohol and drugs and that I am fully aware of my driving hours rules where relevant.</p>
        <div class="form-group">
          <label style="font-weight: normal;">
            <input type="checkbox" id="declarationCheckbox" name="declaration" value="Signed" required>
            I agree to the above declarations
          </label>
        </div>
      </div>
      
      <!-- Navigation Buttons -->
      <div id="navigationButtons">
        <button type="button" id="backBtn">Back</button>
        <button type="button" id="nextBtn">Next</button>
      </div>
    </form>
    
    <!-- FAQ Button -->
    <div id="faqButtonContainer">
      <button type="button" id="openFaqBtn" onclick="openFaq()">FAQ</button>
    </div>
  </div>
  
      <!-- ======================= -->
    <!-- BREAKDOWNS SECTION      -->
    <!-- ======================= -->
    <div id="breakdownsSection" class="container hidden">
      <!-- Back to Home Button -->
      <div style="margin-bottom: 20px;">
        <button id="btnBackToHomeFromBreakdowns"
                style="background:none; border:none; color:#f7941d; font-size:16px; cursor:pointer;">
          &larr; Back to Home
        </button>
      </div>

      <!-- Header (logo/title) -->
      <div class="header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h2>Vehicle Breakdowns</h2>
        <img src="logo.png" alt="Logo" class="logo" style="max-height: 35px; margin-left: 20px;">
      </div>

      <!-- Sub-navigation: Report vs. Update -->
      <div id="breakdownNav" style="text-align: center; margin-bottom: 20px;">
        <button id="btnReportBreakdown">Report a New Breakdown</button>
        <button id="btnUpdateBreakdown">Update or Resolve a Breakdown</button>
      </div>

      <!-- 1) REPORT A BREAKDOWN FORM -->
      <form id="formReportBreakdown" class="hidden">
        <div class="form-group">
          <label>Breakdown Date:</label>
          <div class="date-time-group">
            <input type="date" id="breakdownDate" name="breakdownDate" required />
            <input type="time" id="breakdownTime" name="breakdownTime" required />
          </div>
        </div>

        <!-- “Form Filled In By” as inline radios -->
        <div class="form-group" style="display: flex; gap: 20px; align-items: center;">
          <label style="margin-right: 10px; font-weight: bold;">Breakdown Form Filled in By</label>
          <label style="font-weight: normal; display: flex; align-items: center;">
            <input type="radio" name="filledBy" value="Office" required />
            <span style="margin-left: 4px;">Office</span>
          </label>
          <label style="font-weight: normal; display: flex; align-items: center;">
            <input type="radio" name="filledBy" value="Driver" />
            <span style="margin-left: 4px;">Driver</span>
          </label>
        </div>

        <div class="form-group">
          <label for="breakDriverName">Driver Name:</label>
          <select id="breakDriverName" name="breakDriverName" required>
            <option value="">Select Driver Name</option>
            <option value="Mat Roberts">Mat Roberts</option>
            <option value="Leo Baptiste">Leo Baptiste</option>
            <option value="Ed Sykes">Ed Sykes</option>
            <option value="Stewart Kenny">Stewart Kenny</option>
            <option value="Frank Libal">Frank Libal</option>
            <option value="Chris Bull">Chris Bull</option>
            <option value="Julia Stockdale">Julia Stockdale</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="breakVehicleRegMake">Vehicle Registration &amp; Make:</label>
          <select id="breakVehicleRegMake" name="breakVehicleRegMake" required>
            <option value="">Select Registration &amp; Make</option>
            <option value="BV72 JVN">BV72 JVN - Black Renault Master</option>
            <option value="LB25 UKY">LB25 UKY - White Fiat Luton</option>
            <option value="PY25 CKL">PY25 CKL - White Maxus (new)</option>
            <option value="LO19 CGE">LO19 CGE - Black Citroen Relay</option>
            <option value="PY24 LZE">PY24 LZE - White Maxus</option>
            <option value="Rental Van">Rental Van</option>
          </select>
        </div>

        <div class="form-group">
          <label>Are you in a safe place?</label>
          <label><input type="radio" name="safePlace" value="Yes" required /> Yes</label>
          <label><input type="radio" name="safePlace" value="No" /> No</label>
          <div id="safePlaceWarning" class="hidden">
            Call the office immediately on <strong>01228 521 231</strong> or Chris on <strong>07779 120 063</strong>.
          </div>
        </div>

        <div class="form-group">
          <label for="breakLocation">Location (or What3Words):</label>
          <input
            type="text"
            id="breakLocation"
            name="breakLocation"
            placeholder="e.g. ///apple.banana.orange"
            required
          />
        </div>

        <div class="form-group">
          <label for="breakDescription">Describe the Issue:</label>
          <textarea
            id="breakDescription"
            name="breakDescription"
            rows="3"
            required
          ></textarea>
        </div>

        <div class="form-group">
          <label>Have our insurers been contacted to arrange recovery?</label>
           <label><input type="radio" name="aaContacted" value="Yes" required /> Yes</label>
          <label><input type="radio" name="aaContacted" value="No"/> No</label>
          <!-- Warning shown only if “No” is selected -->
          <div id="aaNoWarning" class="hidden" style="margin-top: 10px; padding: 10px; 
               background-color: #ffe5e5; border: 1px solid #ffcccc; border-radius: 4px; 
               font-size: 0.9em; color: #a94442;">
            Please call Aviva Insurance on <strong>0800 246 876</strong> to arrange recovery. Refer to the breakdowns sheet in the van for the policy reference number.
          </div>
        </div>

        <div class="form-group hidden" id="aaEtaGroup">
          <label for="aaEta">What is the recovery ETA (if known)?</label>
          <input type="text" id="aaEta" name="aaEta" placeholder="e.g. 15:30" disabled />
        </div>

        <div class="form-group">
            <label>Has the office been called?</label>
            <label><input type="radio" name="officeCalled" value="Yes" required /> Yes</label>
            <label><input type="radio" name="officeCalled" value="No" /> No</label>
          </div>

          <div class="form-group hidden" id="colleagueSpokenContainer">
            <label for="colleagueSpoken">Colleague Spoken To:</label>
            <input type="text" id="colleagueSpoken" name="colleagueSpoken" disabled />
          </div>

          <div class="form-group">
            <label>Are there client items on the van?</label>
            <label><input type="radio" name="clientItems" value="Yes" required /> Yes</label>
            <label><input type="radio" name="clientItems" value="No" /> No</label>
          </div>

          <div class="form-group hidden" id="clientItemValueContainer">
            <label for="clientItemValue">Total value of items:</label>
            <input type="text" id="clientItemValue" name="clientItemValue" disabled />
          </div>

        <div style="text-align: center; margin-top: 20px;">
          <button type="submit">Submit Breakdown</button>
        </div>
      </form>

      <!-- 2) UPDATE / RESOLVE A BREAKDOWN FORM -->
      <form id="formUpdateBreakdown" class="hidden">
        <input type="hidden" id="resolved" name="resolved" value="No" />
        <!-- New: First field – two inline radio buttons, only one at a time -->
        <div class="form-group" style="display: flex; gap: 20px; align-items: center;">
          <label style="margin-right: 10px; font-weight: bold;">Choose Type:</label>
          <label style="font-weight: normal; display: flex; align-items: center;">
              <!-- … just above the “Choose Type” radios or anywhere in the form: -->
            <input type="radio" name="updType" value="Breakdown Update" required />
            <span style="margin-left: 4px;">Breakdown Update</span>
          </label>
          <label style="font-weight: normal; display: flex; align-items: center;">
            <input type="radio" name="updType" value="Resolve a Breakdown" />
            <span style="margin-left: 4px;">Resolve a Breakdown</span>
          </label>
        </div>

        <!-- 2) Breakdown Reference (if known) -->
        <div class="form-group">
          <label for="breakdownReference">Breakdown Reference Number (if known):</label>
          <input
            type="text"
            id="breakdownReference"
            name="breakdownReference"
            placeholder="e.g. BRK-20250604-001"
          />
        </div>

        <div class="form-group">
          <label>Update Date:</label>
          <div class="date-time-group">
            <input type="date" id="updateDate" name="updateDate" required />
            <input type="time" id="updateTime" name="updateTime" required />
          </div>
        </div>

        <div class="form-group">
          <label for="updDriverName">Driver Name:</label>
          <select id="updDriverName" name="updDriverName" required>
            <option value="">Select Driver Name</option>
            <option value="Mat Roberts">Mat Roberts</option>
            <option value="Leo Baptiste">Leo Baptiste</option>
            <option value="Ed Sykes">Ed Sykes</option>
            <option value="Stewart Kenny">Stewart Kenny</option>
            <option value="Frank Libal">Frank Libal</option>
            <option value="Chris Bull">Chris Bull</option>
            <option value="Julia Stockdale">Julia Stockdale</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="updVehicleRegMake">Vehicle Registration &amp; Make:</label>
          <select id="updVehicleRegMake" name="updVehicleRegMake" required>
            <option value="">Select Registration &amp; Make</option>
            <option value="BV72 JVN">BV72 JVN - Black Renault Master</option>
            <option value="LB25 UKY">LB25 UKY - White Fiat Luton</option>
            <option value="PY25 CKL">PY25 CKL - White Maxus (new)</option>
            <option value="LO19 CGE">LO19 CGE - Black Citroen Relay</option>
            <option value="PY24 LZE">PY24 LZE - White Maxus</option>
            <option value="Rental Van">Rental Van</option>
          </select>
        </div>

        <div class="form-group">
          <label for="updaterName">Name of Person Giving Update:</label>
          <input type="text" id="updaterName" name="updaterName" required />
        </div>

        <div class="form-group">
          <label for="resolveMethod">Update Description</label>
          <textarea
            id="resolveMethod"
            name="resolveMethod"
            rows="2"
            placeholder="e.g. AA tow to garage, replaced tyre, etc."
            required
          ></textarea>
        </div>

        <!-- “Is the van back in use?” radios -->
        <div class="form-group">
          <label>Is the van back in use?</label>
          <label><input type="radio" name="vanInUse" value="Yes" required /> Yes</label>
          <label style="margin-left: 0px;"><input type="radio" name="vanInUse" value="No" /> No</label>
        </div>

        <div class="form-group hidden" id="artworksGroup">
          <label>If needed, have client items been collected?</label>
          <label><input type="radio" name="artworksCollected" value="Yes" /> Yes</label>
          <label style="margin-left: 0px;"><input type="radio" name="artworksCollected" value="No" /> No</label>
          <label style="margin-left: 0px;"><input type="radio" name="artworksCollected" value="n/a" /> n/a</label>
          <!-- Warning shown only if “No” is selected -->
          <div id="clientItemsWarning" class="hidden" style="margin-top:10px; padding:10px; background-color:#ffe5e5; border:1px solid #ffcccc; border-radius:4px; font-size:0.9em; color:#a94442;">
            Please call the office on <strong>01228 521 231</strong> to arrange collection of these items.
          </div>
        </div>

        <div class="form-group">
          <label>Is the van coming back to Carlisle?</label>
          <label><input type="radio" name="comingToCarlisle" value="Yes" required /> Yes</label>
          <label><input type="radio" name="comingToCarlisle" value="No" /> No</label>
        </div>

        <div style="text-align: center; margin-top: 20px;">
          <button type="submit">Update Breakdown</button>
        </div>
      </form>
    </div>

  <!-- FAQ Modal -->
  <div id="faqModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="closeFaqModal" onclick="closeFaq()">&times;</span>
      <div class="faq-content">
        <h2>Frequently Asked Questions</h2>
        <h3>Why are vehicle checks necessary?</h3>
        <p>Regular vehicle checks are a legal requirement under UK health and safety law. Drivers must ensure that their vehicle is safe and roadworthy to prevent accidents and comply with regulations enforced by the DVSA.</p>
        <h3>What are the two types of checks in this form?</h3>
        <p><strong>First check with vehicle:</strong> This is a comprehensive inspection conducted at the start of your route. It covers detailed assessments of the vehicle’s mechanical systems, safety equipment, and overall condition.</p>
        <p><strong>Subsequent daily walk around checks:</strong> These are simplified, visual inspections carried out later during your route to confirm that no new issues have developed.</p>
        <h3>Do I have to do both checks?</h3>
        <p>If it is your first time using the vehicle on a given route, you must complete the full <strong>first check with vehicle</strong>. For any additional checks during that route, only a <strong>subsequent daily walk around check</strong> is required unless a new shift begins or a different driver uses the vehicle.</p>
        <h3>What are my responsibilities as a driver?</h3>
        <p>You are legally required to check your vehicle before driving. This involves conducting a thorough initial inspection and following up with regular visual checks to ensure ongoing safety. Reporting any faults immediately is a crucial part of your duty to maintain a safe driving environment.</p>
        <h3>What if I find a defect?</h3>
        <p>Any faults must be reported immediately using the reporting fields in this form. Do not drive the vehicle until a manager has assessed the issue and confirmed that it is safe to proceed. While faults are automatically and immediately recorded upon submission of the form, it is strongly encouraged that you also contact a company Director (Chris or Anna) to report the issue and seek guidance on the next steps to ensure safety.</p>
        <h3>How is the information from this form used for vehicle maintenance?</h3>
        <p>The answers provided in this form feed into a central database, which automatically flags defects and highlights when routine servicing is due. It is important that the form is completed accurately and in full to ensure any issues are picked up quickly and the vehicle remains safe and compliant.</p>
        <h3>What should I do if I feel too tired or unwell to drive?</h3>
        <p>While this is not covered directly in the vehicle check form, driver fatigue and general health are important safety considerations. If you feel unwell or too tired to drive safely, this must be reported to a company Director (Chris or Anna) as soon as possible.</p>
        <h3>What happens if I don’t complete the checks properly?</h3>
        <p>Completing vehicle checks is a legal requirement and a condition of using company vehicles. Failure to carry out the necessary checks or report faults properly may result in disciplinary action. All submissions are monitored, and any issues will be followed up by management to ensure continued safety and compliance.</p>
      </div>
    </div>
  </div>
  
  <!-- Camera Modal -->
  <div id="cameraModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="closeCameraModal">&times;</span>
      <video id="cameraStream" autoplay></video>
      <div id="captureStatus" class="hidden">Photo Captured!</div>
      <div style="margin-top:10px;">
        <button type="button" id="capturePhotoModalBtn">Capture Photo</button>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables for step navigation and image handling
    let currentStep = 0;
    let steps = [];
    let galleryFiles = [];
    let capturedBlobs = [];
    let stream;
    const cameraModal = document.getElementById('cameraModal');
    const cameraStreamEl = document.getElementById('cameraStream');
    const captureStatus = document.getElementById('captureStatus');

    // Helper function to validate required fields for the current step.
    function validateStep(stepElement) {
      let valid = true;
      const radioValidated = new Set();
      const inputs = stepElement.querySelectorAll("input, select, textarea");

      inputs.forEach(input => {
        if (input.disabled) return;
        if (input.offsetParent === null) return; // not visible

        // For the daily branch, require all checkboxes to be checked.
        if (stepElement.id === "dailyStep" && input.type === "checkbox") {
          if (!input.checked) {
            valid = false;
            return;
          }
        }

        // Skip the optional notes fields.
        if ((input.id === "dailyNotes" || input.id === "weeklyNotes") && input.tagName.toLowerCase() === "textarea") return;
        // Skip file inputs (images) since they are optional.
        if (input.type === "file") return;
        if (input.hasAttribute("required")) {
          // For radio buttons, ensure one in the group is checked.
          if (input.type === "radio") {
            if (!radioValidated.has(input.name)) {
              const radios = stepElement.querySelectorAll(`input[name="${input.name}"]`);
              const isChecked = Array.from(radios).some(radio => radio.checked);
              if (!isChecked) {
                valid = false;
                radioValidated.add(input.name);
              }
            }
          } else {
            if (input.value.trim() === "") {
              valid = false;
            }
          }
        }
      });

      // Additional check: For Weekly branch in commonDetails, ensure mileage is provided.
      if (document.getElementById("checkType").value === "Weekly" && stepElement.id === "commonDetails") {
        const mileageInput = document.getElementById("currentMileage");
        if (mileageInput && mileageInput.value.trim() === "") {
          valid = false;
        }
      }

      // Weekly-specific validations.
      if (stepElement.id === "weeklyStep") {
        const tyreConditionSelect = document.getElementById("tyreConditionVisual");
        if (tyreConditionSelect && tyreConditionSelect.value === "Poor") {
          const tyreConditionOther = document.getElementById("tyreConditionOtherDetails");
          if (!tyreConditionOther || tyreConditionOther.value.trim() === "") {
            valid = false;
          }
        }
        const bodyworkSelect = document.getElementById("bodyworkGlassAndMirrors");
        if (bodyworkSelect && bodyworkSelect.value === "Poor") {
          const bodyworkOther = document.getElementById("bodyworkOtherDetails");
          if (!bodyworkOther || bodyworkOther.value.trim() === "") {
            valid = false;
          }
        }
        // Weekly fault reporting check.
        const weeklyFaultRadios = stepElement.querySelectorAll('input[name="weeklyFaultOption"]');
        const selectedWeeklyFault = Array.from(weeklyFaultRadios).find(radio => radio.checked);
        if (!selectedWeeklyFault) {
          valid = false;
        } else if (selectedWeeklyFault.value === "Yes") {
          const faultDescWeekly = document.getElementById("weeklyFaultDescription");
          if (!faultDescWeekly || faultDescWeekly.value.trim() === "") {
            valid = false;
          }
        }
      }

      // Daily fault reporting check.
      if (stepElement.id === "dailyStep") {
        const dailyFaultRadios = stepElement.querySelectorAll('input[name="dailyFaultOption"]');
        const selectedDailyFault = Array.from(dailyFaultRadios).find(radio => radio.checked);
        if (!selectedDailyFault) {
          valid = false;
        } else if (selectedDailyFault.value === "Yes") {
          const faultDescDaily = document.getElementById("dailyFaultDescription");
          if (!faultDescDaily || faultDescDaily.value.trim() === "") {
            valid = false;
          }
        }
      }

      return valid;
    }

    // Initialize branch and build steps after DOM is ready
    function initBranch() {
      if (!document.getElementById("checkType").value) {
        document.getElementById("checkType").value = "Daily";
      }
      adjustSteps();
      buildStepsArray();
    }
    
    // Set check type based on user selection
    function setCheckType(type) {
      document.getElementById("checkType").value = type;
      adjustSteps();
      buildStepsArray();
    }
    
    // Toggle common fields based on branch
    function toggleFields() {
      const checkType = document.getElementById("checkType").value;
      if (checkType === "Weekly") {
        document.getElementById("currentMileageGroup").classList.remove("hidden");
      } else {
        document.getElementById("currentMileageGroup").classList.add("hidden");
      }
    }
    
    function disableInputsForStep(stepId, disable) {
      const step = document.getElementById(stepId);
      if (step) {
        step.querySelectorAll("input, select, textarea").forEach(input => {
          input.disabled = disable;
        });
      }
    }

    // Updated adjustSteps() function to disable inputs for the non-active branch
    function adjustSteps() {
      const checkType = document.getElementById("checkType").value;
      if (checkType === "Weekly") {
        document.getElementById("dailyStep").classList.add("hidden");
        disableInputsForStep("dailyStep", true);
        document.getElementById("weeklyStep").classList.remove("hidden");
        disableInputsForStep("weeklyStep", false);
      } else if (checkType === "Daily") {
        document.getElementById("dailyStep").classList.remove("hidden");
        disableInputsForStep("dailyStep", false);
        document.getElementById("weeklyStep").classList.add("hidden");
        disableInputsForStep("weeklyStep", true);
      }
      toggleFields();
    }
    
    // Build steps array based on visible steps
    function buildStepsArray() {
      steps = [];
      document.querySelectorAll('.step').forEach(step => {
        if (!step.classList.contains("hidden")) {
          steps.push(step);
        }
      });
      currentStep = 0;
      showStep(currentStep);
    }
    
    // Display a specific step
    function showStep(index) {
      steps.forEach((step, i) => {
        step.classList.toggle('active', i === index);
      });
      document.getElementById("progressIndicator").innerText = `Step ${index + 1} of ${steps.length}`;
      document.getElementById("backBtn").style.visibility = (index === 0) ? "hidden" : "visible";
      document.getElementById("nextBtn").innerText = (index === steps.length - 1) ? "Submit" : "Next";
      if (steps[index].id === "reviewStep") {
        updateReviewPreviews();
      }
    }
    
    document.addEventListener("DOMContentLoaded", function() {
      // Vehicle Checks: fault option listeners
      document.querySelectorAll('input[name="dailyFaultOption"]').forEach(radio => {
        radio.addEventListener("change", event => {
          const container = document.getElementById("dailyFaultDescriptionContainer");
          const input = document.getElementById("dailyFaultDescription");
          if (event.target.value === "Yes") {
            container.classList.remove("hidden");
            input.disabled = false;
          } else {
            container.classList.add("hidden");
            input.disabled = true;
            input.value = "";
          }
        });
      });
      document.querySelectorAll('input[name="weeklyFaultOption"]').forEach(radio => {
        radio.addEventListener("change", event => {
          const container = document.getElementById("weeklyFaultDescriptionContainer");
          const input = document.getElementById("weeklyFaultDescription");
          if (event.target.value === "Yes") {
            container.classList.remove("hidden");
            input.disabled = false;
          } else {
            container.classList.add("hidden");
            input.disabled = true;
            input.value = "";
          }
        });
      });
      
      // Vehicle Checks: other dynamic fields
      document.getElementById("vehicleReg").addEventListener("change", updateTyrePressureNote);
      updateTyrePressureNote();
      document.getElementById("tyreConditionVisual").addEventListener("change", toggleTyreConditionOther);
      document.getElementById("bodyworkGlassAndMirrors").addEventListener("change", toggleBodyworkOther);
      toggleTyreConditionOther();
      toggleBodyworkOther();
      
      // Next button for Vehicle Checks
      document.getElementById("nextBtn").addEventListener('click', () => {
        const currentStepElement = steps[currentStep];
        if (!validateStep(currentStepElement)) {
          alert("Please fill in all required fields before moving on.");
          return;
        }
        if (currentStep < steps.length - 1) {
          currentStep++;
          showStep(currentStep);
        } else {
          submitForm();
        }
      });
      
      // Back button for Vehicle Checks
      document.getElementById("backBtn").addEventListener('click', () => {
        if (currentStep > 0) {
          currentStep--;
          showStep(currentStep);
        }
      });
      
      // Image upload handlers
      document.getElementById('uploadDeviceBtn').addEventListener('click', () => {
        document.getElementById('galleryUpload').click();
      });
      document.getElementById('galleryUpload').addEventListener('change', function() {
        Array.from(this.files).forEach(file => galleryFiles.push(file));
        updateGalleryPreview();
        markImagesUploaded();
        this.value = "";
      });
      
      // Camera modal handlers
      document.getElementById('openCameraBtn').addEventListener('click', async () => {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          cameraStreamEl.srcObject = stream;
          cameraModal.classList.remove('hidden');
        } catch (err) {
          console.error("Error accessing camera:", err);
          alert("Could not access the camera.");
        }
      });
      document.getElementById('closeCameraModal').addEventListener('click', () => {
        if (stream) { stream.getTracks().forEach(track => track.stop()); }
        cameraModal.classList.add('hidden');
      });
      document.getElementById('capturePhotoModalBtn').addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = cameraStreamEl.videoWidth;
        canvas.height = cameraStreamEl.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(cameraStreamEl, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
          capturedBlobs.push(blob);
          updateCapturedPreview();
          markImagesUploaded();
          captureStatus.classList.remove('hidden');
          setTimeout(() => { captureStatus.classList.add('hidden'); }, 2000);
        }, 'image/jpeg');
      });
      
      // Initialize Vehicle Checks branch
      initBranch();
    });
    
    // Toggle driver "Other" field
    function toggleDriverOther() {
      const driverSelect = document.getElementById("driverName");
      const otherContainer = document.getElementById("otherDriverNameContainer");
      const input = document.getElementById("otherDriverName");
      if (driverSelect.value === "Other") {
        otherContainer.classList.remove("hidden");
        input.disabled = false;
      } else {
        otherContainer.classList.add("hidden");
        input.disabled = true;
        input.value = "";
      }
    }

    function toggleVanOther() {
      const vehicleSelect = document.getElementById("vehicleReg");
      const otherContainer = document.getElementById("rentalVanContainer");
      const input = document.getElementById("rentalVanName");
      if (vehicleSelect.value === "Rental Van") {
        otherContainer.classList.remove("hidden");
        input.disabled = false;
      } else {
        otherContainer.classList.add("hidden");
        input.disabled = true;
        input.value = "";
      }
    }
    
    // Toggle optional tyre condition details
    function toggleTyreConditionOther() {
      const select = document.getElementById("tyreConditionVisual");
      const container = document.getElementById("tyreConditionOtherContainer");
      const input = document.getElementById("tyreConditionOtherDetails");
      if (select.value === "Poor") {
        container.classList.remove("hidden");
        input.disabled = false;
      } else {
        container.classList.add("hidden");
        input.disabled = true;
        input.value = "";
      }
    }
    function toggleBodyworkOther() {
      const select = document.getElementById("bodyworkGlassAndMirrors");
      const container = document.getElementById("bodyworkOtherContainer");
      const input = document.getElementById("bodyworkOtherDetails");
      if (select.value === "Poor") {
        container.classList.remove("hidden");
        input.disabled = false;
      } else {
        container.classList.add("hidden");
        input.disabled = true;
        input.value = "";
      }
    }
    
    // Update tyre pressure recommendation note based on registration
    function updateTyrePressureNote() {
      const regDropdown = document.getElementById("vehicleReg");
      const selectedOption = regDropdown.value;
      const noteField = document.getElementById("tyrePressureNote");
      const recommendations = {
        "BV72 JVN": "Recommended: Front 55 psi, Rear 67 psi",
        "LB25 UKY": "Recommended: Front 55 psi, Rear 67 psi",
        "PY25 CKL": "Recommended: Front 55 psi, Rear 67 psi",
        "LO19 CGE": "Recommended: Front 65 psi, Rear 72.3 psi",
        "PY24 LZE": "Recommended: Front 55 psi, Rear 67 psi"
      };
      noteField.innerText = recommendations[selectedOption] || "";
    }
    
    // FAQ modal functions
    function openFaq() {
      document.getElementById("faqModal").classList.remove("hidden");
    }
    function closeFaq() {
      document.getElementById("faqModal").classList.add("hidden");
    }
    
    // Image preview functions
    function markImagesUploaded() {
      document.getElementById("imagesUploaded").value = "Yes";
    }
    function updateGalleryPreview() {
      const previewContainer = document.getElementById('galleryPreview');
      previewContainer.innerHTML = "";
      galleryFiles.forEach((file, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = "previewItem";
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        const delBtn = document.createElement('button');
        delBtn.innerText = "×";
        delBtn.className = "deleteBtn";
        delBtn.onclick = () => { galleryFiles.splice(index, 1); updateGalleryPreview(); };
        previewItem.appendChild(img);
        previewItem.appendChild(delBtn);
        previewContainer.appendChild(previewItem);
      });
    }
    function updateCapturedPreview() {
      const previewContainer = document.getElementById('capturedPhotos');
      previewContainer.innerHTML = "";
      capturedBlobs.forEach((blob, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = "previewItem";
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        const delBtn = document.createElement('button');
        delBtn.innerText = "×";
        delBtn.className = "deleteBtn";
        delBtn.onclick = () => { capturedBlobs.splice(index, 1); updateCapturedPreview(); };
        previewItem.appendChild(img);
        previewItem.appendChild(delBtn);
        previewContainer.appendChild(previewItem);
      });
    }
    function updateReviewPreviews() {
      const reviewGallery = document.getElementById('reviewGallery');
      const reviewCaptured = document.getElementById('reviewCaptured');
      reviewGallery.innerHTML = "";
      reviewCaptured.innerHTML = "";
      galleryFiles.forEach((file, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = "previewItem";
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        const delBtn = document.createElement('button');
        delBtn.innerText = "×";
        delBtn.className = "deleteBtn";
        delBtn.onclick = () => { galleryFiles.splice(index, 1); updateGalleryPreview(); updateReviewPreviews(); };
        previewItem.appendChild(img);
        previewItem.appendChild(delBtn);
        reviewGallery.appendChild(previewItem);
      });
      capturedBlobs.forEach((blob, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = "previewItem";
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        const delBtn = document.createElement('button');
        delBtn.innerText = "×";
        delBtn.className = "deleteBtn";
        delBtn.onclick = () => { capturedBlobs.splice(index, 1); updateCapturedPreview(); updateReviewPreviews(); };
        previewItem.appendChild(img);
        previewItem.appendChild(delBtn);
        reviewCaptured.appendChild(previewItem);
      });
    }
    
    // Submit form function
    function submitForm() {
      if (!document.getElementById("declarationCheckbox").checked) {
        alert("You must agree to the declaration before submitting the form.");
        return;
      }
      document.getElementById("nextBtn").disabled = true;
      document.getElementById("nextBtn").innerHTML = '<span class="spinner"></span> Submitting...';
      const date = new Date().toISOString();
      const formData = new FormData(document.getElementById('vehicleForm'));
      formData.append("timestamp", date);
      const url = "https://script.google.com/macros/s/AKfycbwcxQA4Cg_mUQ5d9ZdC26zNDZvGlZNIfBTEiQM3LS1oUgIQDnjT4IJuuLUcNDVMpcZsOQ/exec";
      const promises = [];
      
      galleryFiles.forEach((file, i) => {
        const fname = formData.get('vehicleReg').replace(" ", "") + "_" + date + "_" + i + "." + file.name.split('.').pop();
        promises.push(new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = f => {
            const qs = new URLSearchParams({ filename: fname, mimeType: file.type });
            fetch(`${url}?${qs}`, {
              method: "POST",
              body: JSON.stringify([...new Uint8Array(f.target.result)])
            })
            .then(response => response.json())
            .then(data => resolve(data))
            .catch(err => reject(err));
          };
          fr.onerror = err => reject(err);
          fr.readAsArrayBuffer(file);
        }));
      });
      
      capturedBlobs.forEach((blob, i) => {
        const fname = formData.get('vehicleReg').replace(" ", "") + "_" + date + "_captured_" + i + ".jpg";
        promises.push(new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = f => {
            const qs = new URLSearchParams({ filename: fname, mimeType: blob.type });
            fetch(`${url}?${qs}`, {
              method: "POST",
              body: JSON.stringify([...new Uint8Array(f.target.result)])
            })
            .then(response => response.json())
            .then(data => resolve(data))
            .catch(err => reject(err));
          };
          fr.onerror = err => reject(err);
          fr.readAsArrayBuffer(blob);
        }));
      });
      
      promises.push(
        fetch(url, {
          method: "POST",
          body: formData
        }).then(response => response.json())
      );
      
      Promise.all(promises)
        .then(data => {
          alert("Form submitted successfully!");
          document.getElementById('vehicleForm').reset();
          galleryFiles = [];
          capturedBlobs = [];
          updateGalleryPreview();
          updateCapturedPreview();
          updateReviewPreviews();
          document.getElementById("nextBtn").disabled = false;
          document.getElementById("nextBtn").innerText = "Submit";
          currentStep = 0;
          buildStepsArray();
        })
        .catch(error => {
          console.error("Submission error:", error);
          alert("Submission failed. Please try again.");
          document.getElementById("nextBtn").disabled = false;
          document.getElementById("nextBtn").innerText = "Submit";
        });
    }
  </script>

  <script>
  // ================================
  // Landing‐Page and Section Toggles
  // ================================
  document.addEventListener("DOMContentLoaded", function() {
    const landing = document.getElementById("landingPage");
    const vehicleSection = document.getElementById("vehicleChecksSection");
    const breakdownSection = document.getElementById("breakdownsSection");

    // Show Vehicle Checks when clicked
    document.getElementById("btnVehicleChecks").addEventListener("click", function() {
      landing.classList.add("hidden");
      vehicleSection.classList.remove("hidden");
    });

    // Show Breakdowns when clicked
    document.getElementById("btnBreakdowns").addEventListener("click", function() {
      landing.classList.add("hidden");
      breakdownSection.classList.remove("hidden");
    });

    // Back to Home from Vehicle Checks
    document.getElementById("btnBackToHomeFromVehicle").addEventListener("click", function() {
      vehicleSection.classList.add("hidden");
      landing.classList.remove("hidden");
    });

    // Back to Home from Breakdowns
    document.getElementById("btnBackToHomeFromBreakdowns").addEventListener("click", function() {
      breakdownSection.classList.add("hidden");
      landing.classList.remove("hidden");
    });
  });

  // ================================
  // Breakdowns‐Section Script Logic
  // ================================
  const BREAKDOWN_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwo7bTxPs082xSimCVT4QFjaXsoGgmO3slr7YfNRzCbHG5eFhbe4fl_4cX4K4wd9fnx/exec";

  document.addEventListener("DOMContentLoaded", () => {
    const btnReportBreakdown = document.getElementById("btnReportBreakdown");
    const btnUpdateBreakdown = document.getElementById("btnUpdateBreakdown");
    const formReportBreakdown = document.getElementById("formReportBreakdown");
    const formUpdateBreakdown = document.getElementById("formUpdateBreakdown");

    // ── ** MISSING DECLARATIONS (insert these two lines) **
    const updTypeRadios   = document.getElementsByName("updType");
    const resolvedInput   = document.getElementById("resolved");
    // ─────────────────────────────────────────────────────────

    // If “Resolve a Breakdown” is selected, set resolved="Yes". Otherwise "No".
    updTypeRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.value === "Resolve a Breakdown" && radio.checked) {
          resolvedInput.value = "Yes";
        } else if (radio.value === "Breakdown Update" && radio.checked) {
          resolvedInput.value = "No";
        }
      });
    });

    // Toggle which sub‐form is visible and style active button
    function showReportForm() {
      btnReportBreakdown.classList.add("active");
      btnUpdateBreakdown.classList.remove("active");
      formReportBreakdown.classList.remove("hidden");
      formUpdateBreakdown.classList.add("hidden");
    }
    function showUpdateForm() {
      btnUpdateBreakdown.classList.add("active");
      btnReportBreakdown.classList.remove("active");
      formUpdateBreakdown.classList.remove("hidden");
      formReportBreakdown.classList.add("hidden");
    }

    btnReportBreakdown.addEventListener("click", showReportForm);
    btnUpdateBreakdown.addEventListener("click", showUpdateForm);
    // Default to “Report” on first load
    showReportForm();

    // Back to Home button in Breakdown section
    document.getElementById("btnBackToHomeFromBreakdowns").addEventListener("click", () => {
      document.getElementById("breakdownsSection").classList.add("hidden");
      document.getElementById("landingPage").classList.remove("hidden");
    });

    // Safe‐place warning logic
    const safeRadios = document.getElementsByName("safePlace");
    const safeWarning = document.getElementById("safePlaceWarning");
    safeRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.value === "No" && radio.checked) {
          safeWarning.classList.remove("hidden");
        } else if (radio.value === "Yes" && radio.checked) {
          safeWarning.classList.add("hidden");
        }
      });
    });

    // ── “AA Contacted?” logic → show/hide ETA _and_ show/hide Aviva warning
    const aaRadios    = document.getElementsByName("aaContacted");
    const aaEtaGroup  = document.getElementById("aaEtaGroup");
    const aaNoWarning = document.getElementById("aaNoWarning");
    aaRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        const etaInput = document.getElementById("aaEta");
        if (radio.value === "Yes" && radio.checked) {
          aaEtaGroup.classList.remove("hidden");
          etaInput.disabled = false;
          aaNoWarning.classList.add("hidden");
        }
        else if (radio.value === "No" && radio.checked) {
          aaEtaGroup.classList.add("hidden");
          etaInput.disabled = true;
          etaInput.value = "";
          aaNoWarning.classList.remove("hidden");
        }
      });
    });

    // “Has the office been called?” logic
    const officeRadios = document.getElementsByName("officeCalled");
    const colleagueContainer = document.getElementById("colleagueSpokenContainer");
    const colleagueInput     = document.getElementById("colleagueSpoken");
    officeRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.value === "Yes" && radio.checked) {
          colleagueContainer.classList.remove("hidden");
          colleagueInput.disabled = false;
        } else if (radio.value === "No" && radio.checked) {
          colleagueContainer.classList.add("hidden");
          colleagueInput.disabled = true;
          colleagueInput.value = "";
        }
      });
    });

    // ── “Client items on van?” logic
    const clientItemsOnVanRadios   = document.getElementsByName("clientItems");
    const clientItemValueContainer = document.getElementById("clientItemValueContainer");
    const clientItemValueInput     = document.getElementById("clientItemValue");
    clientItemsOnVanRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.value === "Yes" && radio.checked) {
          clientItemValueContainer.classList.remove("hidden");
          clientItemValueInput.disabled = false;
        } else if (radio.value === "No" && radio.checked) {
          clientItemValueContainer.classList.add("hidden");
          clientItemValueInput.disabled = true;
          clientItemValueInput.value = "";
        }
      });
    });

    // ── “Van back in use?” logic → show/hide “client items collected”
    const vanInUseRadios = document.getElementsByName("vanInUse");
    const artworksGroup  = document.getElementById("artworksGroup");
    vanInUseRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.value === "No" && radio.checked) {
          artworksGroup.classList.remove("hidden");
        } else if (radio.value === "Yes" && radio.checked) {
          artworksGroup.classList.add("hidden");
          document.querySelectorAll('input[name="artworksCollected"]').forEach(i => i.checked = false);
        }
      });
    });

    // ── “Artworks collected?” logic → show/hide client‐items warning
    const artworksCollectedRadios = document.getElementsByName("artworksCollected");
    const clientItemsWarning      = document.getElementById("clientItemsWarning");
    artworksCollectedRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.value === "No" && radio.checked) {
          clientItemsWarning.classList.remove("hidden");
        } else if (radio.value === "Yes" && radio.checked) {
          clientItemsWarning.classList.add("hidden");
        }
      });
    });
     
    formReportBreakdown.addEventListener("submit", e => {
      e.preventDefault();

      // 1) Grab the <button type="submit"> inside this form:
      const btn = formReportBreakdown.querySelector('button[type="submit"]');
      // 2) Disable it and change its text:
      btn.disabled = true;
      btn.textContent = "Submitting…";

      fetch(BREAKDOWN_WEBAPP_URL, {
        method: "POST",
        body: new FormData(formReportBreakdown)
      })
      .then(resp => resp.json())
      .then(json => {
        btn.disabled = false;
        btn.textContent = "Submit Breakdown"; // revert to original
        if (json.result === "success") {
          alert("Breakdown reported successfully!\nReference ID: " + json.referenceID);
          formReportBreakdown.reset();
          showReportForm();
        } else {
          alert("Error: " + json.message);
        }
      })
      .catch(err => {
        btn.disabled = false;
        btn.textContent = "Submit Breakdown";
        console.error("Fetch error:", err);
        alert("Submission failed. Please try again.");
      });
    });

    formUpdateBreakdown.addEventListener("submit", e => {
      e.preventDefault();

      // Grab the Update form’s submit button:
      const btn = formUpdateBreakdown.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = "Submitting…";

      fetch(BREAKDOWN_WEBAPP_URL, {
        method: "POST",
        body: new FormData(formUpdateBreakdown)
      })
      .then(resp => resp.json())
      .then(json => {
        btn.disabled = false;
        btn.textContent = "Update Breakdown"; // revert 
        if (json.result === "success") {
          alert("Breakdown updated successfully!");
          formUpdateBreakdown.reset();
          showUpdateForm();
        } else {
          alert("Error: " + json.message);
        }
      })
      .catch(err => {
        btn.disabled = false;
        btn.textContent = "Update Breakdown";
        console.error("Fetch error:", err);
        alert("Update failed. Please try again.");
      });
    });
   }); 
</script>
</body>
</html>
