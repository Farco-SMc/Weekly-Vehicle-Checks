<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vehicle Checks and Maintenance</title>
  <style>
    /* Header styling with logo */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .logo {
      max-height: 35px; /* Adjust this value to scale the logo */
      width: auto;
      margin-left: 20px;
    }
    /* Base styling */
    body {
      font-family: "Gill Sans", "Segoe UI", sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
      color: #34434c;
    }
    .container {
      max-width: 600px;
      background-color: #ffffff;
      margin: auto;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h2 {
      font-family: "Begum Semi Bold", "Gill Sans", sans-serif;
      font-size: 28px;
      margin-bottom: 10px;
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #a1afae;
      border-radius: 4px;
      box-sizing: border-box;
    }
    input[type="checkbox"],
    input[type="radio"] {
      margin-right: 8px;
    }
    button {
      background-color: #f7941d; /* FARCO Orange */
      color: #ffffff;
      padding: 12px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #d77c15;
    }
    .hidden {
      display: none;
    }
    /* Step wizard styles */
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    #progressIndicator {
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
    }
    /* Navigation buttons: Back always on left (using visibility so space remains) and Next always on right */
    #navigationButtons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    #backBtn {
      visibility: hidden; /* Reserve space even when hidden */
    }
    /* Preview container and delete button */
    .previewContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .previewItem {
      position: relative;
      display: inline-block;
    }
    .previewItem img {
      max-width: 100px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .deleteBtn {
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 12px;
      line-height: 18px;
      padding: 0;
    }
    /* Image options buttons */
    #imageOptions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    #imageOptions button {
      flex: 1;
    }
    /* Modal for camera interface */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.hidden {
      display: none !important;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      position: relative;
      text-align: left;
      max-width: 90%;
      width: 400px;
    }
    .faq-content {
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content video {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .modal-content .close {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 36px;
      cursor: pointer;
      color: #aaa;
      padding: 10px;
      line-height: 1;
      z-index: 10;            /* ← NEW: keeps button on top so it receives the click */
    }
    @media (max-width: 600px) {          /* adjust breakpoint if needed */
      .modal-content .close {
        font-size: 44px;  /* <— make larger on small screens */
        padding: 14px;    /* a bit more tap target */
      }
    }
    #captureStatus {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 16px;
      z-index: 1100;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #f7941d;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #faqButtonContainer {
      text-align: center;
      margin-top: 20px;
    }
    .fluid-grid-row {
      display: grid;
      grid-template-columns: 120px repeat(3, 1fr);
      align-items: center;
      gap: 6px;
      padding: 2px 0;
      margin-bottom: 12px;
      font-weight: normal;
      font-size: 0.95em;
    }
    .fluid-label {
      width: 100px;
      font-weight: bold;
      font-size: 0.95em;
      color: #444;
    }
    .fluid-grid-row label {
      margin-right: 15px;
      font-weight: normal;
      font-size: 0.95em;
    }
    textarea#dailyNotes,
    textarea#weeklyNotes {
      font-family: "Gill Sans", sans-serif;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Vehicle Checks and Maintenance</h2>
      <img src="logo.png" alt="Logo" class="logo">
    </div>
    <div id="progressIndicator">Step 1</div>
    <form id="vehicleForm" method="POST" enctype="multipart/form-data">
      <!-- Hidden fields -->
      <input type="hidden" id="checkType" name="checkType" />
      <input type="hidden" id="imagesUploaded" name="imagesUploaded" value="No">
      
      <!-- Step 1: Common Details -->
      <div class="step" id="commonDetails">
        <div class="form-group">
          <label>Is this your first vehicle check for this vehicle as part of this route?</label>
          <input type="radio" name="firstCheck" value="Yes" required onclick="setCheckType('Weekly')"> Yes
          <input type="radio" name="firstCheck" value="No" onclick="setCheckType('Daily')"> No
        </div>
        <div class="form-group">
          <label for="driverName">Driver Name:</label>
          <select id="driverName" name="driverName" required onchange="toggleDriverOther()">
            <option value="">Select Driver Name</option>
            <option value="Mat Roberts">Mat Roberts</option>
            <option value="Leo Baptiste">Leo Baptiste</option>
            <option value="Ed Sykes">Ed Sykes</option>
            <option value="Stewart Kenny">Stewart Kenny</option>
            <option value="Frank Libal">Frank Libal</option>
            <option value="Chris Bull">Chris Bull</option>
            <option value="Julia Stockdale">Julia Stockdale</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group hidden" id="otherDriverNameContainer">
          <label for="otherDriverName">Please enter driver name:</label>
          <input type="text" id="otherDriverName" name="otherDriverName">
        </div>
        <div class="form-group">
          <label for="vehicleReg">Vehicle Registration:</label>
          <select id="vehicleReg" name="vehicleReg" required onchange="toggleVanOther()" required onchange="updateTyrePressureNote()">
            <option value="">Select Registration</option>
            <option value="BV72 JVN">BV72 JVN - Black Renault Master</option>
            <option value="SN71 AZG">SN71 AZG - Grey Nissan Luton</option>
            <option value="PY25 CKL">PY25 CKL - White Maxus (new)</option>
            <option value="LO19 CGE">LO19 CGE - Black Citroen Relay</option>
            <option value="PY24 LZE">PY24 LZE - White Maxus</option>
            <option value="Rental Van">Rental Van</option>
          </select>
        </div>
        <div class="form-group hidden" id="rentalVanContainer">
          <label for="rentalVanName">Please enter rental van registration, make and model:</label>
          <input type="text" id="rentalVanName" name="rentalVanName">
        </div>
        <div class="form-group hidden" id="currentMileageGroup">
          <label for="currentMileage">Current Mileage:</label>
          <input type="text" id="currentMileage" name="currentMileage" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
        </div>
      </div>
      
      <!-- Step 2a: Daily Check Fields (for Daily branch) -->
      <div class="step" id="dailyStep">
        <div class="form-group">
          <label><input type="checkbox" name="vehicleWalkAround" value="complete"> Vehicle Walk Around Completed</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
          Visually inspect the exterior, checking for any obvious damage, loose parts, or debris.
        </span>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="checkLights" value="checked"> Lights Checked</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
          Confirm that all exterior lights (headlights, tail lights, indicators) are functioning correctly.
        </span>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="dashLightsWorkingDaily" value="checked"> Dash Lights Checked</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
          Ensure the instrument panel lights are working and clearly visible.
        </span>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="checkFluidLevels" value="checked"> Fluid Levels Checked</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
          Check engine oil, coolant, and other fluids for proper levels.
        </span>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="checkTyres" value="checked"> Tyres Checked</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
          Inspect tyres for tread depth, damage to side walls, proper inflation and check that wheel nuts are secure.
        </span>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="checkBrakes" value="checked"> Brakes Checked</label>
          <span style="font-weight: normal; font-size: 0.85em; color: #555;">
          Test that the brakes are functioning before setting off.
        </span>
        </div>
        <div class="form-group">
          <label>Fault or Damage?</label>
          <input type="radio" name="dailyFaultOption" value="Yes" id="dailyFaultYes"> Yes
          <input type="radio" name="dailyFaultOption" value="No" id="dailyFaultNo" checked> No
        </div>
        <div class="form-group hidden" id="dailyFaultDescriptionContainer">
          <label for="dailyFaultDescription">Please describe the fault/damage:</label>
          <input type="text" id="dailyFaultDescription" name="dailyFaultDescription">
        </div>
        <div class="form-group">
          <label for="dailyNotes">Other Notes and Comments:</label>
          <textarea id="dailyNotes" name="dailyNotes" rows="3" placeholder="Optional notes about the vehicle or check..."></textarea>
        </div>
      </div>
      
      <!-- Step 2b: Weekly Check Fields (for Weekly branch) -->
      <div class="step hidden" id="weeklyStep">
       <div class="form-group">
          <label>Tyre Pressure (psi):</label>
          <p style="font-size: 0.9em; color: #555; margin: -2px 0 10px;">Orientation is from the perspective of driving the vehicle.</p>
          <p id="tyrePressureNote" style="font-size: 0.9em; color: #333; font-weight: bold;"></p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label for="tyrePressureFrontLeft">Front Left:</label>
              <input type="text" id="tyrePressureFrontLeft" name="tyrePressureFrontLeft" inputmode="decimal"
                pattern="[0-9]+(\.[0-9]{1,2})?" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required>
            </div>
            <div>
              <label for="tyrePressureFrontRight">Front Right:</label>
              <input type="text" id="tyrePressureFrontRight" name="tyrePressureFrontRight" inputmode="decimal"
                pattern="[0-9]+(\.[0-9]{1,2})?" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required>
            </div>
            <div>
              <label for="tyrePressureBackLeft">Back Left:</label>
              <input type="text" id="tyrePressureBackLeft" name="tyrePressureBackLeft" inputmode="decimal"
                pattern="[0-9]+(\.[0-9]{1,2})?" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required>
            </div>
            <div>
              <label for="tyrePressureBackRight">Back Right:</label>
              <input type="text" id="tyrePressureBackRight" name="tyrePressureBackRight" inputmode="decimal"
                pattern="[0-9]+(\.[0-9]{1,2})?" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="tyreConditionVisual">
            Tyre Condition – Visual Check:
            <span style="display:block; font-weight: normal; font-size: 0.9em; color: #555; margin: 1px 0 10px;">Check for damage, wear, or balding.</span>
          </label>
          <select id="tyreConditionVisual" name="tyreConditionVisual" required onchange="toggleTyreConditionOther()">
            <option value="">Select Condition</option>
            <option value="Good">No visible issues</option>
            <option value="Okay">Minor wear or surface damage</option>
            <option value="Poor">Visible damage or unsafe</option>
          </select>
          <div class="form-group hidden" id="tyreConditionOtherContainer">
            <label for="tyreConditionOtherDetails">Please describe the damage:</label>
            <input type="text" id="tyreConditionOtherDetails" name="tyreConditionOtherDetails">
          </div>
        </div>
        <div class="form-group">
          <label style="font-weight: bold;">
            Are all of the tyre treads safe and in line with legal limits?
            <span style="display:block; font-weight: normal; font-size: 0.9em; color: #555; margin: 1px 0 10px;">
              Note: Legal minimum tread depth is 1.6mm across the central three-quarters.
            </span>
          </label>
          <div style="display: flex; gap: 20px;">
            <label style="font-weight: normal;">
              <input type="radio" name="tyreTreadSafety" value="Yes" required> Yes
            </label>
            <label style="font-weight: normal;">
              <input type="radio" name="tyreTreadSafety" value="No"> No
            </label>
          </div>
        </div>
        <div class="form-group">
          <label for="bodyworkGlassAndMirrors">Bodywork, Glass and Mirrors:</label>
          <p style="font-size: 0.9em; color: #555; margin: 1px 0 10px;">Includes windscreen, mirrors, lights, and doors.</p>
          <select id="bodyworkGlassAndMirrors" name="bodyworkGlassAndMirrors" required>
            <option value="">Select Condition</option>
            <option value="Good">No visible damage</option>
            <option value="Okay">Minor scratches/chips</option>
            <option value="Poor">Cracks, missing parts or unsafe damage</option>
          </select>
          <div class="form-group hidden" id="bodyworkOtherContainer">
            <label for="bodyworkOtherDetails">Please describe the damage:</label>
            <input type="text" id="bodyworkOtherDetails" name="bodyworkOtherDetails">
          </div>
        </div>
        <div class="form-group">
          <label>Brakes working? (incl lights):</label>
          <input type="radio" name="brakes" value="Yes" required> Yes
          <input type="radio" name="brakes" value="No"> No
        </div>
        <div class="form-group">
          <label>Steering and suspension working?</label>
          <input type="radio" name="steeringSuspension" value="Yes" required> Yes
          <input type="radio" name="steeringSuspension" value="No"> No
        </div>
        <div class="form-group">
          <label>Lights and reflectors working?</label>
          <input type="radio" name="lightsReflectors" value="Yes" required> Yes
          <input type="radio" name="lightsReflectors" value="No"> No
        </div>
        <div class="form-group">
          <label>Dash Lights working?</label>
          <input type="radio" name="dashLightsWorkingWeekly" value="Yes" required> Yes
          <input type="radio" name="dashLightsWorkingWeekly" value="No"> No
        </div>
        <div class="form-group">
          <label>Horn working?</label>
          <input type="radio" name="horn" value="Yes" required> Yes
          <input type="radio" name="horn" value="No"> No
        </div>
        <div class="form-group">
          <label>Fluid Levels:</label>
          <div class="fluid-grid-row">
            <div class="fluid-label">Oil:</div>
            <label><input type="radio" name="oilLevel" value="Good" required> Good</label>
            <label><input type="radio" name="oilLevel" value="Needs refilling"> Needs refilling</label>
          </div>
          <div class="fluid-grid-row">
            <div class="fluid-label">Coolant:</div>
            <label><input type="radio" name="coolantLevel" value="Good" required> Good</label>
            <label><input type="radio" name="coolantLevel" value="Needs refilling"> Needs refilling</label>
          </div>
          <div class="fluid-grid-row">
            <div class="fluid-label">AdBlue:</div>
            <label><input type="radio" name="adblueLevel" value="Good" required> Good</label>
            <label><input type="radio" name="adblueLevel" value="Needs refilling"> Needs refilling</label>
            <label><input type="radio" name="adblueLevel" value="N/a"> N/a</label>
          </div>
          <div class="fluid-grid-row">
            <div class="fluid-label">Screenwash:</div>
            <label><input type="radio" name="screenwashLevel" value="Good" required> Good</label>
            <label><input type="radio" name="screenwashLevel" value="Needs refilling">Needs refilling</label>
          </div>
        </div>
        <div class="form-group">
          <label>Driver Van Kit and First Aid Kit Present?</label>
          <input type="radio" name="driverVanKitFirstAid" value="Yes" required> Yes
          <input type="radio" name="driverVanKitFirstAid" value="No"> No
        </div>
        <div class="form-group">
          <label>Fault or Damage?</label>
          <input type="radio" name="weeklyFaultOption" value="Yes"> Yes
          <input type="radio" name="weeklyFaultOption" value="No" checked> No
        </div>
        <div class="form-group hidden" id="weeklyFaultDescriptionContainer">
          <label for="weeklyFaultDescription">Please describe the fault/damage:</label>
          <input type="text" id="weeklyFaultDescription" name="weeklyFaultDescription">
        </div>
        <div class="form-group">
          <label for="weeklyNotes">Other Notes and Comments:</label>
          <textarea id="weeklyNotes" name="weeklyNotes" rows="3" placeholder="Optional notes about the vehicle or check..."></textarea>
        </div>
      </div>
      
      <!-- Step 3: Image Upload -->
      <div class="step" id="imageUploadStep">
        <div class="form-group">
          <label>Add Image(s):</label>
          <div id="imageOptions">
            <button type="button" id="uploadDeviceBtn">Upload from Device</button>
            <button type="button" id="openCameraBtn">Take Photo</button>
          </div>
          <p style="font-size: 0.9em; color: #666;">Select images from your device or capture new ones.</p>
        </div>
        <input type="file" id="galleryUpload" accept="image/*" multiple style="display:none;">
        <div id="galleryPreview" class="previewContainer"></div>
        <div id="capturedPhotos" class="previewContainer"></div>
      </div>
      
      <!-- Step 4: Review -->
      <div class="step" id="reviewStep">
        <h3 style="text-align:center;">Review Your Images</h3>
        <p style="font-size: 0.9em; color: #666; text-align:center;">Click the red delete icon to remove an image.</p>
        <div id="reviewGallery" class="previewContainer"></div>
        <div id="reviewCaptured" class="previewContainer"></div>
      </div>
      
      <!-- Step 5: Declaration -->
      <div class="step" id="declarationStep">
        <h3 style="text-align:center;">Declaration</h3>
        <p>I confirm that the above checks have been carried out and I consider the vehicle fit for use.</p>
        <p>I hereby confirm that I am fit to drive/use this vehicle, that I am aware of the company policies and the law on alcohol and drugs and that I am fully aware of my driving hours rules where relevant.</p>
        <div class="form-group">
          <label style="font-weight: normal;">
            <input type="checkbox" id="declarationCheckbox" name="declaration" value="Signed" required>
            I agree to the above declarations
          </label>
        </div>
      </div>
      
      <!-- Navigation Buttons -->
      <div id="navigationButtons">
        <button type="button" id="backBtn">Back</button>
        <button type="button" id="nextBtn">Next</button>
      </div>
    </form>
    
    <!-- FAQ Button -->
    <div id="faqButtonContainer">
      <button type="button" id="openFaqBtn" onclick="openFaq()">FAQ</button>
    </div>
  </div>
  
  <!-- FAQ Modal -->
  <div id="faqModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="closeFaqModal" onclick="closeFaq()">&times;</span>
      <div class="faq-content">
        <h2>Frequently Asked Questions</h2>
        <h3>Why are vehicle checks necessary?</h3>
        <p>Regular vehicle checks are a legal requirement under UK health and safety law. Drivers must ensure that their vehicle is safe and roadworthy to prevent accidents and comply with regulations enforced by the DVSA.</p>
        <h3>What are the two types of checks in this form?</h3>
        <p><strong>First check with vehicle:</strong> This is a comprehensive inspection conducted at the start of your route. It covers detailed assessments of the vehicle’s mechanical systems, safety equipment, and overall condition.</p>
        <p><strong>Subsequent daily walk around checks:</strong> These are simplified, visual inspections carried out later during your route to confirm that no new issues have developed.</p>
        <h3>Do I have to do both checks?</h3>
        <p>If it is your first time using the vehicle on a given route, you must complete the full <strong>first check with vehicle</strong>. For any additional checks during that route, only a <strong>subsequent daily walk around check</strong> is required unless a new shift begins or a different driver uses the vehicle.</p>
        <h3>What are my responsibilities as a driver?</h3>
        <p>You are legally required to check your vehicle before driving. This involves conducting a thorough initial inspection and following up with regular visual checks to ensure ongoing safety. Reporting any faults immediately is a crucial part of your duty to maintain a safe driving environment.</p>
        <h3>What if I find a defect?</h3>
        <p>Any faults must be reported immediately using the reporting fields in this form. Do not drive the vehicle until a manager has assessed the issue and confirmed that it is safe to proceed. While faults are automatically and immediately recorded upon submission of the form, it is strongly encouraged that you also contact a company Director (Chris or Anna) to report the issue and seek guidance on the next steps to ensure safety.</p>
        <h3>How is the information from this form used for vehicle maintenance?</h3>
        <p>The answers provided in this form feed into a central database, which automatically flags defects and highlights when routine servicing is due. It is important that the form is completed accurately and in full to ensure any issues are picked up quickly and the vehicle remains safe and compliant.</p>
        <h3>What should I do if I feel too tired or unwell to drive?</h3>
        <p>While this is not covered directly in the vehicle check form, driver fatigue and general health are important safety considerations. If you feel unwell or too tired to drive safely, this must be reported to a company Director (Chris or Anna) as soon as possible.</p>
        <h3>What happens if I don’t complete the checks properly?</h3>
        <p>Completing vehicle checks is a legal requirement and a condition of using company vehicles. Failure to carry out the necessary checks or report faults properly may result in disciplinary action. All submissions are monitored, and any issues will be followed up by management to ensure continued safety and compliance.</p>
      </div>
    </div>
  </div>
  
  <!-- Camera Modal -->
  <div id="cameraModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="closeCameraModal">&times;</span>
      <video id="cameraStream" autoplay></video>
      <div id="captureStatus" class="hidden">Photo Captured!</div>
      <div style="margin-top:10px;">
        <button type="button" id="capturePhotoModalBtn">Capture Photo</button>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables for step navigation and image handling
    let currentStep = 0;
    let steps = [];
    let galleryFiles = [];
    let capturedBlobs = [];
    let stream;
    const cameraModal = document.getElementById('cameraModal');
    const cameraStreamEl = document.getElementById('cameraStream');
    const captureStatus = document.getElementById('captureStatus');

    // Helper function to validate required fields for the current step.
    // Skips hidden, disabled fields as well as the "other notes and comments" fields and file inputs.
   function validateStep(stepElement) {
      let valid = true;
      const radioValidated = new Set();
      const inputs = stepElement.querySelectorAll("input, select, textarea");

      inputs.forEach(input => {
        if (input.disabled) return;
        if (input.offsetParent === null) return; // not visible

        // For the daily branch, require all checkboxes to be checked.
        if (stepElement.id === "dailyStep" && input.type === "checkbox") {
          if (!input.checked) {
            valid = false;
            return;
          }
        }

        // Skip the optional notes fields.
        if ((input.id === "dailyNotes" || input.id === "weeklyNotes") && input.tagName.toLowerCase() === "textarea") return;
        // Skip file inputs (images) since they are optional.
        if (input.type === "file") return;
        if (input.hasAttribute("required")) {
          // For radio buttons, ensure one in the group is checked.
          if (input.type === "radio") {
            if (!radioValidated.has(input.name)) {
              const radios = stepElement.querySelectorAll(`input[name="${input.name}"]`);
              const isChecked = Array.from(radios).some(radio => radio.checked);
              if (!isChecked) {
                valid = false;
                radioValidated.add(input.name);
              }
            }
          } else {
            if (input.value.trim() === "") {
              valid = false;
            }
          }
        }
      });

      // Additional check: For Weekly branch in commonDetails, ensure mileage is provided.
      if (document.getElementById("checkType").value === "Weekly" && stepElement.id === "commonDetails") {
        const mileageInput = document.getElementById("currentMileage");
        if (mileageInput && mileageInput.value.trim() === "") {
          valid = false;
        }
      }

      // Weekly-specific validations.
      if (stepElement.id === "weeklyStep") {
        const tyreConditionSelect = document.getElementById("tyreConditionVisual");
        if (tyreConditionSelect && tyreConditionSelect.value === "Poor") {
          const tyreConditionOther = document.getElementById("tyreConditionOtherDetails");
          if (!tyreConditionOther || tyreConditionOther.value.trim() === "") {
            valid = false;
          }
        }
        const bodyworkSelect = document.getElementById("bodyworkGlassAndMirrors");
        if (bodyworkSelect && bodyworkSelect.value === "Poor") {
          const bodyworkOther = document.getElementById("bodyworkOtherDetails");
          if (!bodyworkOther || bodyworkOther.value.trim() === "") {
            valid = false;
          }
        }
        // Weekly fault reporting check.
        const weeklyFaultRadios = stepElement.querySelectorAll('input[name="weeklyFaultOption"]');
        const selectedWeeklyFault = Array.from(weeklyFaultRadios).find(radio => radio.checked);
        if (!selectedWeeklyFault) {
          valid = false;
        } else if (selectedWeeklyFault.value === "Yes") {
          const faultDescWeekly = document.getElementById("weeklyFaultDescription");
          if (!faultDescWeekly || faultDescWeekly.value.trim() === "") {
            valid = false;
          }
        }
      }

      // Daily fault reporting check.
      if (stepElement.id === "dailyStep") {
        const dailyFaultRadios = stepElement.querySelectorAll('input[name="dailyFaultOption"]');
        const selectedDailyFault = Array.from(dailyFaultRadios).find(radio => radio.checked);
        if (!selectedDailyFault) {
          valid = false;
        } else if (selectedDailyFault.value === "Yes") {
          const faultDescDaily = document.getElementById("dailyFaultDescription");
          if (!faultDescDaily || faultDescDaily.value.trim() === "") {
            valid = false;
          }
        }
      }

      return valid;
    }

    // Initialize branch and build steps after DOM is ready
    function initBranch() {
      if (!document.getElementById("checkType").value) {
        document.getElementById("checkType").value = "Daily";
      }
      adjustSteps();
      buildStepsArray();
      console.log("Initial branch set to: " + document.getElementById("checkType").value);
    }
    
    // Set check type based on user selection
    function setCheckType(type) {
      document.getElementById("checkType").value = type;
      adjustSteps();
      buildStepsArray();
      console.log("Branch changed to: " + type);
    }
    
    // Toggle common fields based on branch
    function toggleFields() {
      const checkType = document.getElementById("checkType").value;
      if (checkType === "Weekly") {
        document.getElementById("currentMileageGroup").classList.remove("hidden");
      } else {
        document.getElementById("currentMileageGroup").classList.add("hidden");
      }
    }
    
    function disableInputsForStep(stepId, disable) {
      const step = document.getElementById(stepId);
      if (step) {
        step.querySelectorAll("input, select, textarea").forEach(input => {
          input.disabled = disable;
        });
      }
    }

    // Updated adjustSteps() function to disable inputs for the non-active branch
    function adjustSteps() {
      const checkType = document.getElementById("checkType").value;
      if (checkType === "Weekly") {
        // Hide and disable the daily step so its values won't be submitted
        document.getElementById("dailyStep").classList.add("hidden");
        disableInputsForStep("dailyStep", true);
        // Show and enable the weekly step
        document.getElementById("weeklyStep").classList.remove("hidden");
        disableInputsForStep("weeklyStep", false);
      } else if (checkType === "Daily") {
        // Show and enable the daily step
        document.getElementById("dailyStep").classList.remove("hidden");
        disableInputsForStep("dailyStep", false);
        // Hide and disable the weekly step so its values won't be submitted
        document.getElementById("weeklyStep").classList.add("hidden");
        disableInputsForStep("weeklyStep", true);
      }
      toggleFields();
    }
    
    // Build steps array based on visible steps
    function buildStepsArray() {
      steps = [];
      document.querySelectorAll('.step').forEach(step => {
        if (!step.classList.contains("hidden")) {
          steps.push(step);
        }
      });
      currentStep = 0;
      showStep(currentStep);
      console.log("Steps built. Total visible steps: " + steps.length);
    }
    
    // Display a specific step
    function showStep(index) {
      steps.forEach((step, i) => {
        step.classList.toggle('active', i === index);
      });
      document.getElementById("progressIndicator").innerText = `Step ${index + 1} of ${steps.length}`;
      document.getElementById("backBtn").style.visibility = (index === 0) ? "hidden" : "visible";
      document.getElementById("nextBtn").innerText = (index === steps.length - 1) ? "Submit" : "Next";
      if (steps[index].id === "reviewStep") {
        updateReviewPreviews();
      }
      console.log("Showing step: " + (index + 1));
    }
    
    // Navigation button event listeners setup
    document.addEventListener("DOMContentLoaded", function() {
      // Attach fault option event listeners
      document.querySelectorAll('input[name="dailyFaultOption"]').forEach(radio => {
        radio.addEventListener("change", event => {
          const container = document.getElementById("dailyFaultDescriptionContainer");
          if (event.target.value === "Yes") {
            container.classList.remove("hidden");
            container.querySelector("input").disabled = false;
          } else {
            container.classList.add("hidden");
            container.querySelector("input").disabled = true;
          }
        });
      });
      document.querySelectorAll('input[name="weeklyFaultOption"]').forEach(radio => {
        radio.addEventListener("change", event => {
          const container = document.getElementById("weeklyFaultDescriptionContainer");
          if (event.target.value === "Yes") {
            container.classList.remove("hidden");
            container.querySelector("input").disabled = false;
          } else {
            container.classList.add("hidden");
            container.querySelector("input").disabled = true;
          }
        });
      });
      
      // Attach change events for vehicle registration and other fields
      document.getElementById("vehicleReg").addEventListener("change", updateTyrePressureNote);
      updateTyrePressureNote();
      document.getElementById("tyreConditionVisual").addEventListener("change", toggleTyreConditionOther);
      toggleTyreConditionOther();
      document.getElementById("bodyworkGlassAndMirrors").addEventListener("change", toggleBodyworkOther);
      toggleBodyworkOther();
      
      // Replace the existing Next button event listener with the updated version below:
      document.getElementById("nextBtn").addEventListener('click', () => {
        const currentStepElement = steps[currentStep];
        // Validate the current step; if validation fails, alert and do not proceed.
        if (!validateStep(currentStepElement)) {
          alert("Please fill in all required fields before moving on.");
          return;
        }
        if (currentStep < steps.length - 1) {
          currentStep++;
          showStep(currentStep);
        } else {
          submitForm();
        }
      });
      
      // Attach Back button event listener
      document.getElementById("backBtn").addEventListener('click', () => {
        if (currentStep > 0) {
          currentStep--;
          showStep(currentStep);
        }
      });
      
      // Attach image upload event listeners
      document.getElementById('uploadDeviceBtn').addEventListener('click', () => {
        document.getElementById('galleryUpload').click();
      });
      document.getElementById('galleryUpload').addEventListener('change', function() {
        Array.from(this.files).forEach(file => galleryFiles.push(file));
        updateGalleryPreview();
        markImagesUploaded();
        this.value = "";
      });
      
      // Attach camera modal event listeners
      document.getElementById('openCameraBtn').addEventListener('click', async () => {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          cameraStreamEl.srcObject = stream;
          cameraModal.classList.remove('hidden');
        } catch (err) {
          console.error("Error accessing camera:", err);
          alert("Could not access the camera.");
        }
      });
      document.getElementById('closeCameraModal').addEventListener('click', () => {
        if (stream) { stream.getTracks().forEach(track => track.stop()); }
        cameraModal.classList.add('hidden');
      });
      document.getElementById('capturePhotoModalBtn').addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = cameraStreamEl.videoWidth;
        canvas.height = cameraStreamEl.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(cameraStreamEl, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
          capturedBlobs.push(blob);
          updateCapturedPreview();
          markImagesUploaded();
          captureStatus.classList.remove('hidden');
          setTimeout(() => { captureStatus.classList.add('hidden'); }, 2000);
        }, 'image/jpeg');
      });
      
      // Finally, initialize branch and build steps
      initBranch();
    });
    
    // Toggle driver "Other" field
    function toggleDriverOther() {
      const driverSelect = document.getElementById("driverName");
      const otherContainer = document.getElementById("otherDriverNameContainer");
      if (driverSelect.value === "Other") {
        otherContainer.classList.remove("hidden");
        otherContainer.querySelector("input").disabled = false;
      } else {
        otherContainer.classList.add("hidden");
        otherContainer.querySelector("input").disabled = true;
      }
    }

    function toggleVanOther() {
      const driverSelect = document.getElementById("vehicleReg");
      const otherContainer = document.getElementById("rentalVanContainer");
      if (driverSelect.value === "Rental Van") {
        otherContainer.classList.remove("hidden");
        otherContainer.querySelector("input").disabled = false;
      } else {
        otherContainer.classList.add("hidden");
        otherContainer.querySelector("input").disabled = true;
      }
    }
    
    // Toggle optional tyre condition details
    function toggleTyreConditionOther() {
      const select = document.getElementById("tyreConditionVisual");
      const container = document.getElementById("tyreConditionOtherContainer");
      const input = document.getElementById("tyreConditionOtherDetails");
      if (select.value === "Poor") {
        container.classList.remove("hidden");
        input.disabled = false;
      } else {
        container.classList.add("hidden");
        input.disabled = true;
        input.value = "";
      }
    }
    function toggleBodyworkOther() {
      const select = document.getElementById("bodyworkGlassAndMirrors");
      const container = document.getElementById("bodyworkOtherContainer");
      const input = document.getElementById("bodyworkOtherDetails");
      if (select.value === "Poor") {
        container.classList.remove("hidden");
        input.disabled = false;
      } else {
        container.classList.add("hidden");
        input.disabled = true;
        input.value = "";
      }
    }
    
    // Update tyre pressure recommendation note based on registration
    function updateTyrePressureNote() {
      const regDropdown = document.getElementById("vehicleReg");
      const selectedOption = regDropdown.value;
      const noteField = document.getElementById("tyrePressureNote");
      const recommendations = {
        "BV72 JVN": "Recommended: Front 55 psi, Rear 67 psi",
        "SN71 AZG": "Recommended: Front 55 psi, Rear 67 psi",
        "PY25 CKL": "Recommended: Front 55 psi, Rear 67 psi",
        "LO19 CGE": "Recommended: Front 65 psi, Rear 72.3 psi",
        "PY24 LZE": "Recommended: Front 55 psi, Rear 67 psi"
      };
      noteField.innerText = recommendations[selectedOption] || "";
    }
    
    // FAQ modal functions
    function openFaq() {
      document.getElementById("faqModal").classList.remove("hidden");
    }
    function closeFaq() {
      document.getElementById("faqModal").classList.add("hidden");
    }
    
    // Image preview functions
    function markImagesUploaded() {
      document.getElementById("imagesUploaded").value = "Yes";
    }
    function updateGalleryPreview() {
      const previewContainer = document.getElementById('galleryPreview');
      previewContainer.innerHTML = "";
      galleryFiles.forEach((file, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = "previewItem";
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        const delBtn = document.createElement('button');
        delBtn.innerText = "×";
        delBtn.className = "deleteBtn";
        delBtn.onclick = () => { galleryFiles.splice(index, 1); updateGalleryPreview(); };
        previewItem.appendChild(img);
        previewItem.appendChild(delBtn);
        previewContainer.appendChild(previewItem);
      });
    }
    function updateCapturedPreview() {
      const previewContainer = document.getElementById('capturedPhotos');
      previewContainer.innerHTML = "";
      capturedBlobs.forEach((blob, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = "previewItem";
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        const delBtn = document.createElement('button');
        delBtn.innerText = "×";
        delBtn.className = "deleteBtn";
        delBtn.onclick = () => { capturedBlobs.splice(index, 1); updateCapturedPreview(); };
        previewItem.appendChild(img);
        previewItem.appendChild(delBtn);
        previewContainer.appendChild(previewItem);
      });
    }
    function updateReviewPreviews() {
      const reviewGallery = document.getElementById('reviewGallery');
      const reviewCaptured = document.getElementById('reviewCaptured');
      reviewGallery.innerHTML = "";
      reviewCaptured.innerHTML = "";
      galleryFiles.forEach((file, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = "previewItem";
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        const delBtn = document.createElement('button');
        delBtn.innerText = "×";
        delBtn.className = "deleteBtn";
        delBtn.onclick = () => { galleryFiles.splice(index, 1); updateGalleryPreview(); updateReviewPreviews(); };
        previewItem.appendChild(img);
        previewItem.appendChild(delBtn);
        reviewGallery.appendChild(previewItem);
      });
      capturedBlobs.forEach((blob, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = "previewItem";
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        const delBtn = document.createElement('button');
        delBtn.innerText = "×";
        delBtn.className = "deleteBtn";
        delBtn.onclick = () => { capturedBlobs.splice(index, 1); updateCapturedPreview(); updateReviewPreviews(); };
        previewItem.appendChild(img);
        previewItem.appendChild(delBtn);
        reviewCaptured.appendChild(previewItem);
      });
    }
    
    // Submit form function
    function submitForm() {
      if (!document.getElementById("declarationCheckbox").checked) {
        alert("You must agree to the declaration before submitting the form.");
        return;
      }
      document.getElementById("nextBtn").disabled = true;
      document.getElementById("nextBtn").innerHTML = '<span class="spinner"></span> Submitting...';
      const date = new Date().toISOString();
      const formData = new FormData(document.getElementById('vehicleForm'));
      formData.append("timestamp", date);
      const url = "https://script.google.com/macros/s/AKfycbwcxQA4Cg_mUQ5d9ZdC26zNDZvGlZNIfBTEiQM3LS1oUgIQDnjT4IJuuLUcNDVMpcZsOQ/exec";
      const promises = [];
      
      galleryFiles.forEach((file, i) => {
        const fname = formData.get('vehicleReg').replace(" ", "") + "_" + date + "_" + i + "." + file.name.split('.').pop();
        promises.push(new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = f => {
            const qs = new URLSearchParams({ filename: fname, mimeType: file.type });
            fetch(`${url}?${qs}`, {
              method: "POST",
              body: JSON.stringify([...new Uint8Array(f.target.result)])
            })
            .then(response => response.json())
            .then(data => resolve(data))
            .catch(err => reject(err));
          };
          fr.onerror = err => reject(err);
          fr.readAsArrayBuffer(file);
        }));
      });
      
      capturedBlobs.forEach((blob, i) => {
        const fname = formData.get('vehicleReg').replace(" ", "") + "_" + date + "_captured_" + i + ".jpg";
        promises.push(new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = f => {
            const qs = new URLSearchParams({ filename: fname, mimeType: blob.type });
            fetch(`${url}?${qs}`, {
              method: "POST",
              body: JSON.stringify([...new Uint8Array(f.target.result)])
            })
            .then(response => response.json())
            .then(data => resolve(data))
            .catch(err => reject(err));
          };
          fr.onerror = err => reject(err);
          fr.readAsArrayBuffer(blob);
        }));
      });
      
      promises.push(
        fetch(url, {
          method: "POST",
          body: formData
        }).then(response => response.json())
      );
      
      Promise.all(promises)
        .then(data => {
          alert("Form submitted successfully!");
          document.getElementById('vehicleForm').reset();
          galleryFiles = [];
          capturedBlobs = [];
          updateGalleryPreview();
          updateCapturedPreview();
          updateReviewPreviews();
          document.getElementById("nextBtn").disabled = false;
          document.getElementById("nextBtn").innerText = "Submit";
          currentStep = 0;
          buildStepsArray();
        })
        .catch(error => {
          console.error("Submission error:", error);
          alert("Submission failed. Please try again.");
          document.getElementById("nextBtn").disabled = false;
          document.getElementById("nextBtn").innerText = "Submit";
        });
    }
  </script>
</body>
</html>
